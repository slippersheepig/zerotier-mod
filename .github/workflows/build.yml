name: Build & Release APK

on:
  repository_dispatch:
    types: [build-on-demand]
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      corever: ${{ env.corever }}
    steps:
      - name: Checkout ZeroTierFix
        uses: actions/checkout@v4
        with:
          repository: "kaaass/ZerotierFix"
          path: "ZerotierFix"
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: "ZeroTierFix-Build"
      - name: Change Source
        run: |
          export version=$(curl "https://api.github.com/repos/zerotier/ZeroTierOne/releases/latest" | jq -r '.name')
          export ver=${version//./}
          echo "corever=$ver" >> $GITHUB_ENV
          echo "::set-output name=corever::$ver"
          cd ZerotierFix/app
          sed -r -i "s/versionName \"(.*?)\"/versionName \"\1_$ver\"/g" build.gradle
          cd ..
          rm -rf externals
          mkdir externals
      - name: Checkout ZeroTierOne
        uses: actions/checkout@v4
        with:
          repository: "zerotier/ZeroTierOne"
          path: "ZerotierFix/externals/core"
          ref: "main"
      - name: Fix CMake
        run: |
          cd ZerotierFix/externals/core/java
          rm CMakeLists.txt
          cp ../../../../ZeroTierFix-Build/CMakeLists.txt .
          cd ../../../../
      - name: Build APK
        uses: sparkfabrik/android-build-action@v1.5.0
        with:
          project-path: ZerotierFix
          output-path: ZerotierFix-${{ env.corever }}.apk
          gradle-task: assemble
          ruby-version: "3.3.0"
      - name: Sign APK
        id: sign_app
        uses: noriban/sign-android-release@v5.1
        with:
          releaseDirectory: .
          signingKeyBase64: ${{ secrets.KEYSTORE }}
          keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
          alias: ${{ secrets.KEYSTORE_ALIAS }}
      - name: Upload apk
        uses: actions/upload-artifact@v4
        with:
          name: ZerotierFix-${{ env.corever }}
          path: ${{ steps.sign_app.outputs.signedReleaseFile }}

  release:
    name: Publish GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download signed APK
        uses: actions/download-artifact@v4
        with:
          name: ZerotierFix-${{ needs.build.outputs.corever }}
          path: ./output
      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.corever }}
          name: Release ${{ needs.build.outputs.corever }}
          generate_release_notes: true
          files: |
            output/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
